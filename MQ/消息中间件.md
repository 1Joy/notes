# 消息中间件

## 背景

在微服务架构中，将一个系统拆分为多个模块，系统间的RPC交互复杂，一个功能背后可能要调用很多接口来完成，就产生了下面的问题：

1. 系统之间的耦合严重

   每新增一个下游功能，就要对上有的相关接口进行改造。

   ![avatar](.\imgs\1.PNG)

2. 面对大流量并发时，容易被冲垮

3. 等待同步存在性能问题

   RPC接口上基本都是同步调用的，整体的服务性能遵循“木桶理论”，即整体的耗时取决于链路中最慢的那个接口

   > 木桶理论：一只木桶盛水的多少，并不取决于桶壁上最高的那块木块，而恰恰取决于桶壁上最短的那块

## 定义

1. 消息中间件(MOM)：能够解决上述的问题，值利用搞笑可靠的消息传递机制与平台无关的数据交流，并基于数据通信来进行分布式系统的集成

2. 通过提供消息传递和消息排队模型在分布式环境下提供应用解耦、弹性伸缩、冗余存储、流量削峰、异步通信、数据同步等功能

3. 过程：

   - 发送方把消息发给服务器，消息服务器将消息存放在队列/主题中，消息服务器将消息发送给接收方。在这个过程中发送和接收是异步的，发送方无需等待，而且发送方和接收方的生命周期没有必要的关系

   - 在发布/订阅模式下，也可以完成一对多的通信

   ![avatar](.\imgs\2.PNG)

## 应用场景

1. 异步处理

   串行：

   ![avatar](.\imgs\3.PNG)

   并行：

   ![avatar](.\imgs\4.PNG)

   消息队列：

   ![avatar](.\imgs\5.PNG)

2. 应用解耦

3. 流量削峰

   大量的请求进入后端逻辑，为解决此问题，一般在应用前端加入消息队列。

# RabbitMQ

## RabbitMQ集群

1. **普通集群(主备架构)**

   ![avatar](.\imgs\6.PNG)

2. **镜像集群**

   ![avatar](.\imgs\7.PNG)

   - **LVS**：虚IP，当HaProxy宕机时，可以将请求转发到其他的HaProxy
   - **HaProxy**：负载均衡器，分流消费者请求

